<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחולל אליאס + מילות מילוי + עיצוב ותצוגה מקדימה</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            padding: 20px;
            text-align: center;
            color: #333;
        }
        .container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 650px;
            margin: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 { color: #553c9a; margin-bottom: 10px; margin-top: 0; }
        
        /* --- Stats Bar --- */
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background-color: #f0ebf8;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #d6bcfa;
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: #553c9a; }
        .stat-label { font-size: 0.8rem; color: #666; }

        /* --- Slider Control --- */
        .slider-container {
            background: #fafafa;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed #ccc;
            margin-bottom: 20px;
            text-align: center;
        }
        .slider-label {
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
            color: #444;
        }
        input[type=range] {
            width: 100%;
            margin: 10px 0;
            accent-color: #553c9a;
        }
        .slider-val-display {
            font-size: 1.1em;
            color: #553c9a;
            font-weight: bold;
        }

        /* --- Design & Preview Panel --- */
        .design-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            background: #fafafa;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed #ccc;
            margin-bottom: 20px;
            text-align: right;
        }
        .design-controls {
            flex: 1;
            min-width: 250px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .color-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            padding: 5px 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .color-item label {
            font-size: 0.9em;
            font-weight: bold;
            color: #444;
        }
        .color-item input[type="color"] {
            border: none;
            width: 35px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            padding: 0;
            background: none;
        }
        .width-item {
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .width-item label {
            font-size: 0.9em;
            font-weight: bold;
            color: #444;
            display: flex;
            justify-content: space-between;
        }

        /* --- Live Card Preview --- */
        .preview-wrapper {
            flex: 1;
            min-width: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .preview-title {
            font-size: 0.85em;
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }
        .card-preview {
            width: 130px;
            height: 185px; /* פרופורציה של כרטיס אמיתי */
            border: 1px dashed #000;
            position: relative;
            box-sizing: border-box;
            padding: 10px; /* מייצג את ה-Padding של 5 מ"מ */
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            transition: all 0.2s ease;
        }
        .card-preview-inner {
            flex: 1;
            border: 2px solid #553c9a;
            box-sizing: border-box;
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s ease;
        }
        .preview-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: bold;
            font-family: inherit;
        }

        textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            box-sizing: border-box;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: right;
            margin-bottom: 20px;
            font-family: inherit;
        }
        textarea:focus { border-color: #553c9a; outline: none; }
        
        button {
            background-color: #553c9a;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: background 0.2s;
        }
        button:hover { background-color: #44307b; }
        #status { margin-top: 15px; font-weight: bold; color: #555; }
    </style>
</head>
<body>

    <div class="container">
        <h1>מחולל אליאס</h1>
        
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-value" id="finalWordCount">0</span>
                <span class="stat-label">סה"כ מילים</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="cardCount">0</span>
                <span class="stat-label">כרטיסים</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="pageCount">0</span>
                <span class="stat-label">עמודים</span>
            </div>
        </div>

        <div class="slider-container">
            <label class="slider-label">יעד מילים סופי (כולל מילוי): <span id="sliderValue" class="slider-val-display">0</span></label>
            <input type="range" id="wordGoalSlider" min="0" max="300" value="0" oninput="updateStats()">
            <div style="font-size: 0.8em; color: #888; margin-top:5px;">
                (מינימום: המילים שהקלדת | מקסימום: 300)
            </div>
        </div>

        <div class="design-panel">
            <div class="design-controls">
                <div class="color-item">
                    <label>צבע רקע (עמוד)</label>
                    <input type="color" id="bgColor" value="#ffffff" oninput="updatePreview()">
                </div>
                <div class="color-item">
                    <label>צבע מסגרת פנימית</label>
                    <input type="color" id="borderColor" value="#553c9a" oninput="updatePreview()">
                </div>
                <div class="color-item">
                    <label>צבע טקסט</label>
                    <input type="color" id="textColor" value="#000000" oninput="updatePreview()">
                </div>
                <div class="color-item">
                    <label>צבע מספור</label>
                    <input type="color" id="numberColor" value="#e53e3e" oninput="updatePreview()">
                </div>
                <div class="width-item">
                    <label>
                        <span>עובי מסגרת (מ"מ):</span>
                        <span id="borderWidthDisplay" style="color: #553c9a;">1.0</span>
                    </label>
                    <input type="range" id="borderWidth" min="0.1" max="4.0" step="0.1" value="1.0" oninput="updatePreview()">
                </div>
            </div>

            <div class="preview-wrapper">
                <div class="preview-title">תצוגה מקדימה חיה</div>
                <div id="cardPreview" class="card-preview">
                    <div id="cardPreviewInner" class="card-preview-inner">
                        <div class="preview-row">
                            <span class="preview-text">דוגמה</span>
                            <span class="preview-num">.1</span>
                        </div>
                        <div class="preview-row">
                            <span class="preview-text">אליאס</span>
                            <span class="preview-num">.2</span>
                        </div>
                        <div class="preview-row">
                            <span class="preview-text">עיצוב</span>
                            <span class="preview-num">.3</span>
                        </div>
                        <div class="preview-row">
                            <span class="preview-text">צבעים</span>
                            <span class="preview-num">.4</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <textarea id="wordInput" placeholder="הדבק את המילים שלך כאן..." oninput="handleInput()"></textarea>
        
        <button onclick="generateRealPDF()">הורד קובץ PDF</button>
        <div id="status"></div>
    </div>

    <script>
        const FILLER_POOL = [
            "שמש", "מטרייה", "גלידה", "רכבת", "חלון", "מפתח", "כדור", "מחברת", "עוגה", "שולחן",
            "כיסא", "טלפון", "שעון", "ים", "הר", "נהר", "ענן", "פרח", "עץ", "דשא",
            "כלב", "חתול", "ציפור", "דג", "סוס", "אוטובוס", "מכונית", "אופניים", "מטוס", "סירה",
            "כובע", "חולצה", "נעליים", "גרביים", "מעיל", "תיק", "משקפיים", "טבעת", "שרשרת", "שעון יד",
            "מטבח", "סלון", "חדר", "מיטה", "כרית", "שמיכה", "מראה", "מנורה", "דלת", "מדרגות",
            "בית", "רחוב", "גשר", "פארק", "חוף", "אי", "מדבר", "יער", "עיר", "כפר",
            "ספר", "סיפור", "ציור", "מוזיקה", "שיר", "סרט", "תיאטרון", "ריקוד", "משחק", "חידה",
            "מחשב", "מקלדת", "עכבר", "מסך", "מצלמה", "רמקול", "אוזניות", "סוללה", "אינטרנט", "אפליקציה",
            "אוכל", "שתייה", "לחם", "גבינה", "פסטה", "אורז", "סלט", "מרק", "שוק", "בלון",
            "מתנה", "מסיבה", "רעש", "שקט", "צחוק", "בכי", "חלום", "סיוט", "תקווה", "חופש",
            "עבודה", "לימודים", "מבחן", "תשובה", "שאלה", "רעיון", "זיכרון", "הפתעה", "סוד", "מלך",
            "מלכה", "נסיך", "נסיכה", "גיבור", "נבל", "קוסם", "דרקון", "חרב", "מגן", "גשם",
            "שלג", "ברק", "רוח", "סערה", "קיץ", "חורף", "אביב", "סתיו", "טיפה", "מדינה",
            "גבול", "מפה", "דגל", "שדה", "כביש", "רמזור", "תחנה", "נמל", "חבר", "חברה",
            "משפחה", "אמא", "אבא", "אח", "אחות", "דוד", "דודה", "סבא", "סבתא", "ילד",
            "ילדה", "תינוק", "מבוגר", "שכן", "מורה", "תלמיד", "רופא", "נהג", "מטבע", "כסף",
            "ארנק", "קנייה", "מכירה", "חנות", "קבלה", "הנחה", "מחיר", "חשבון", "כדורגל", "כדורסל",
            "טניס", "שחייה", "ריצה", "קפיצה", "שער", "קבוצה", "מאמן", "שופט", "בוקר", "צהריים",
            "ערב", "לילה", "שבוע", "חודש", "שנה", "אתמול", "מחר", "עכשיו"
        ];

        function getUserWords() {
            const input = document.getElementById('wordInput').value;
            return input.split('\n').map(w => w.trim()).filter(w => w.length > 0);
        }

        function handleInput() {
            const userWords = [...new Set(getUserWords())];
            const slider = document.getElementById('wordGoalSlider');
            const currentCount = userWords.length;
            slider.min = currentCount;
            if (parseInt(slider.value) < currentCount) slider.value = currentCount;
            updateStats();
        }

        function getFinalList() {
            const userWords = [...new Set(getUserWords())];
            const sliderVal = parseInt(document.getElementById('wordGoalSlider').value);
            let finalList = [...userWords];
            const needed = sliderVal - finalList.length;
            
            if (needed > 0) {
                const availableFillers = FILLER_POOL.filter(w => !finalList.includes(w));
                for (let i = availableFillers.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [availableFillers[i], availableFillers[j]] = [availableFillers[j], availableFillers[i]];
                }
                const fillersToAdd = availableFillers.slice(0, needed);
                finalList = finalList.concat(fillersToAdd);
            }
            return finalList;
        }

        function updateStats() {
            const slider = document.getElementById('wordGoalSlider');
            const display = document.getElementById('sliderValue');
            display.innerText = slider.value;
            const totalWords = parseInt(slider.value);
            const totalCards = Math.ceil(totalWords / 4);
            const totalPages = Math.ceil(totalCards / 9);
            document.getElementById('finalWordCount').innerText = totalWords;
            document.getElementById('cardCount').innerText = totalCards;
            document.getElementById('pageCount').innerText = totalPages;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) { binary += String.fromCharCode(bytes[i]); }
            return window.btoa(binary);
        }

        function reverseString(str) {
            return str.split("").reverse().join("");
        }

        function getContrastColor(hexcolor) {
            hexcolor = hexcolor.replace("#", "");
            const r = parseInt(hexcolor.substr(0,2),16);
            const g = parseInt(hexcolor.substr(2,2),16);
            const b = parseInt(hexcolor.substr(4,2),16);
            const yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? '#000000' : '#ffffff';
        }

        // --- עדכון התצוגה המקדימה החיה ---
        function updatePreview() {
            const bgColor = document.getElementById('bgColor').value;
            const borderColor = document.getElementById('borderColor').value;
            const textColor = document.getElementById('textColor').value;
            const numberColor = document.getElementById('numberColor').value;
            const borderWidth = document.getElementById('borderWidth').value;

            // עדכון תצוגת המספר של עובי המסגרת
            document.getElementById('borderWidthDisplay').innerText = parseFloat(borderWidth).toFixed(1);

            const card = document.getElementById('cardPreview');
            const innerCard = document.getElementById('cardPreviewInner');
            const texts = document.querySelectorAll('.preview-text');
            const numbers = document.querySelectorAll('.preview-num');

            // רקע וניגודיות סימני חיתוך
            card.style.backgroundColor = bgColor;
            card.style.borderColor = getContrastColor(bgColor);

            // מסגרת פנימית (הכפלה קלה בפיקסלים כדי שייראה יחסי לתצוגה)
            innerCard.style.border = `${borderWidth * 1.5}px solid ${borderColor}`;

            // צבעי טקסט ומספר
            texts.forEach(t => t.style.color = textColor);
            numbers.forEach(n => n.style.color = numberColor);
        }

        async function generateRealPDF() {
            let words = getFinalList();
            const statusDiv = document.getElementById('status');
            
            if (words.length === 0) { alert("אנא הכנס מילים או הזז את הסליידר."); return; }
            statusDiv.innerText = "מכין את הקובץ...";

            const bgColor = document.getElementById('bgColor').value;
            const borderColor = document.getElementById('borderColor').value;
            const textColor = document.getElementById('textColor').value;
            const numberColor = document.getElementById('numberColor').value;
            const borderWidth = parseFloat(document.getElementById('borderWidth').value);
            
            const cutMarkColor = getContrastColor(bgColor);

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                const fontFilename = 'GoogleSans_17pt-Medium.ttf';
                try {
                    const response = await fetch(fontFilename);
                    if (!response.ok) throw new Error("Font file not found");
                    const buffer = await response.arrayBuffer();
                    const fontBase64 = arrayBufferToBase64(buffer);
                    doc.addFileToVFS(fontFilename, fontBase64);
                    doc.addFont(fontFilename, 'CustomFont', 'normal');
                    doc.setFont('CustomFont');
                } catch (fontError) {
                    statusDiv.innerText = "שגיאה: קובץ הפונט חסר.";
                    alert("לא ניתן לטעון את הפונט. ודא ש-GoogleSans_17pt-Medium.ttf קיים באותה תיקייה.");
                    return;
                }

                const margin = 10; 
                const pageWidth = 210;
                const pageHeight = 297;
                const cols = 3;
                const rows = 3;
                const printableWidth = pageWidth - (margin * 2);
                const printableHeight = pageHeight - (margin * 2);
                const cardWidth = printableWidth / cols;
                const cardHeight = printableHeight / rows;

                for (let i = words.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [words[i], words[j]] = [words[j], words[i]];
                }

                const wordsPerCard = 4;
                const cardsPerPage = cols * rows; 
                
                let cards = [];
                for (let i = 0; i < words.length; i += wordsPerCard) {
                    cards.push(words.slice(i, i + wordsPerCard));
                }

                let pages = [];
                for (let i = 0; i < cards.length; i += cardsPerPage) {
                    pages.push(cards.slice(i, i + cardsPerPage));
                }

                pages.forEach((pageCards, pageIdx) => {
                    if (pageIdx > 0) doc.addPage();
                    
                    doc.setFillColor(bgColor);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');

                    pageCards.forEach((cardWords, cardIdx) => {
                        const colIdx = cardIdx % cols; 
                        const rowIdx = Math.floor(cardIdx / cols);
                        const xPos = margin + ((cols - 1 - colIdx) * cardWidth);
                        const yPos = margin + (rowIdx * cardHeight);

                        const pad = 5; 
                        doc.setDrawColor(borderColor);
                        doc.setLineWidth(borderWidth); 
                        doc.setLineDashPattern([], 0); 
                        doc.rect(xPos + pad, yPos + pad, cardWidth - (pad * 2), cardHeight - (pad * 2), 'S');

                        doc.setDrawColor(cutMarkColor);
                        doc.setLineWidth(0.2);
                        doc.setLineDashPattern([3, 3], 0); 
                        doc.rect(xPos, yPos, cardWidth, cardHeight, 'S');

                        doc.setFontSize(13);

                        const textRightEdge = xPos + cardWidth - pad - 4;
                        const textTopStart = yPos + pad + 15;
                        const lineHeight = 10;
                        const spaceWidth = doc.getTextWidth(" ");

                        cardWords.forEach((word, wIdx) => {
                            const yText = textTopStart + (wIdx * lineHeight);
                            
                            const numStr = (wIdx + 1) + ".";
                            const revNumStr = reverseString(numStr);
                            
                            doc.setTextColor(numberColor);
                            doc.text(revNumStr, textRightEdge, yText, { align: 'right' });
                            
                            const numWidth = doc.getTextWidth(revNumStr);
                            
                            const revWord = reverseString(word);
                            doc.setTextColor(textColor);
                            doc.text(revWord, textRightEdge - numWidth - spaceWidth, yText, { align: 'right' });
                        });
                    });
                });

                statusDiv.innerText = "ההורדה החלה!";
                doc.save('Elias_Cards_Customized.pdf');
                
                setTimeout(() => { statusDiv.innerText = "הקובץ מוכן."; }, 2000);

            } catch (e) {
                console.error(e);
                statusDiv.innerText = "שגיאה: " + e.message;
            }
        }
        
        // אתחול נתונים ותצוגה מקדימה בטעינת העמוד
        window.onload = () => {
            updateStats();
            updatePreview();
        };
    </script>
</body>
</html>
