<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hebrew Cards Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            padding: 20px;
            text-align: center;
        }
        .container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            max-width: 600px;
            margin: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            text-align: right;
            margin-bottom: 20px;
        }
        button {
            background-color: #007bff; /* Blue */
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }
        #status {
            margin-top: 15px;
            color: #333;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>מחולל כרטיסים (תיקון היפוך)</h2>
        <p style="font-size: 0.9em; color: #666;">
            Make sure <strong>GoogleSans_17pt-Medium.ttf</strong> is in the same folder.
        </p>
        <textarea id="wordInput" placeholder="הדבק מילים כאן..."></textarea>
        <button onclick="generateRealPDF()">Download PDF</button>
        <div id="status"></div>
    </div>

    <script>
        // Helper: Convert binary font data to Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // Helper: Manually reverse text for visual RTL
        // "1. שלום" -> becomes -> "םולש .1"
        // This tricks the LTR PDF engine into drawing Hebrew correctly.
        function reverseString(str) {
            return str.split("").reverse().join("");
        }

        async function generateRealPDF() {
            const input = document.getElementById('wordInput').value;
            const statusDiv = document.getElementById('status');
            
            let words = input.split('\n').map(w => w.trim()).filter(w => w.length > 0);
            if (words.length === 0) { alert("אנא הכנס מילים"); return; }

            statusDiv.innerText = "Generating PDF...";

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                // --- FONT LOADING ---
                const fontFilename = 'GoogleSans_17pt-Medium.ttf';
                try {
                    const response = await fetch(fontFilename);
                    if (!response.ok) throw new Error("Font file not found");
                    const buffer = await response.arrayBuffer();
                    const fontBase64 = arrayBufferToBase64(buffer);

                    doc.addFileToVFS(fontFilename, fontBase64);
                    doc.addFont(fontFilename, 'CustomFont', 'normal');
                    doc.setFont('CustomFont');
                } catch (fontError) {
                    statusDiv.innerText = "Error: Font not found.";
                    alert("Could not load 'GoogleSans_17pt-Medium.ttf'.\nPlease upload it to the same folder as this HTML file.");
                    return;
                }

                // --- CONFIGURATION ---
                const margin = 10; 
                const pageWidth = 210;
                const pageHeight = 297;
                const cols = 2;
                const rows = 4;
                
                const printableWidth = pageWidth - (margin * 2);
                const printableHeight = pageHeight - (margin * 2);
                
                const cardWidth = printableWidth / cols;
                const cardHeight = printableHeight / rows;

                // --- SHUFFLE ---
                for (let i = words.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [words[i], words[j]] = [words[j], words[i]];
                }

                const wordsPerCard = 4;
                const cardsPerPage = cols * rows;
                let cards = [];
                for (let i = 0; i < words.length; i += wordsPerCard) {
                    cards.push(words.slice(i, i + wordsPerCard));
                }
                let pages = [];
                for (let i = 0; i < cards.length; i += cardsPerPage) {
                    pages.push(cards.slice(i, i + cardsPerPage));
                }

                // --- DRAWING ---
                pages.forEach((pageCards, pageIdx) => {
                    if (pageIdx > 0) doc.addPage();
                    
                    doc.setLineWidth(0.1); 
                    doc.setDrawColor(100); 
                    doc.setLineDashPattern([3, 3], 0); 

                    pageCards.forEach((cardWords, cardIdx) => {
                        const colIdx = cardIdx % cols; 
                        const rowIdx = Math.floor(cardIdx / cols);

                        // RTL Layout Logic
                        // Even though we reverse text, we still need to calculate the BOX position correctly
                        // col 0 is Right, col 1 is Left
                        const xPos = margin + ((cols - 1 - colIdx) * cardWidth);
                        const yPos = margin + (rowIdx * cardHeight);

                        doc.rect(xPos, yPos, cardWidth, cardHeight);

                        doc.setFontSize(14);
                        doc.setTextColor(0);

                        // Align text to the RIGHT edge of the card
                        const textRightEdge = xPos + cardWidth - 10;
                        const textTopStart = yPos + 25; 
                        const lineHeight = 9;

                        cardWords.forEach((word, wIdx) => {
                            // 1. Create the string "1. Word"
                            let fullString = `${wIdx + 1}. ${word}`;
                            
                            // 2. Reverse the ENTIRE string for the fix
                            // "1. שלום" becomes "םולש .1"
                            let reversedString = reverseString(fullString);

                            // 3. Draw it ALIGNED RIGHT, but turn OFF the 'rtl' flag
                            // We are manually feeding it visual RTL, so we tell the PDF it's standard text.
                            doc.text(reversedString, textRightEdge, textTopStart + (wIdx * lineHeight), { 
                                align: 'right',
                                rtl: false  // Important: We handled RTL ourselves
                            });
                        });
                    });
                });

                statusDiv.innerText = "Downloading...";
                doc.save('HebrewCards_Fixed.pdf');
                statusDiv.innerText = "Done! Check your Downloads.";

            } catch (e) {
                console.error(e);
                statusDiv.innerText = "Error: " + e.message;
            }
        }
    </script>
</body>
</html>
